actor MjolnirCrash: Boolean {}
actor StrongerMjolnir: Boolean {}

actor Mjolnir: InstantSwitchWeapon
{
    +CHEATNOTWEAPON
    +NOALERT
    +AMMO_OPTIONAL
    +WEAPON.NOAUTOAIM
	Inventory.RestrictedTo "QuakePlayer"
	Weapon.BobRangeX 0
	Weapon.BobRangeY 0.75
	Weapon.BobSpeed 1.4
	Weapon.BobStyle Alpha   
    Weapon.SelectionOrder 8
    Obituary "$SAMSARA_RANGER_OB_SLOT1_1"
    Weapon.YAdjust 24

    States
    {
      Select:
		TNT1 A 0 A_GiveInventory("Ranger_AxeSelected", 1)
		TNT1 A 0 A_TakeInventory("Ranger_GunSelected", 1)
        TNT1 A 0 A_TakeInventory("Ranger_ExplosiveSelected", 1)
		TNT1 A 0 A_TakeInventory("Ranger_NailSelected", 1)
		TNT1 A 0 A_TakeInventory("Ranger_PlasmaSelected", 1)
		TNT1 AAAAAAAAAAAAAAAAAAAA 0 A_Raise
        TNT1 A 1 A_Raise
        loop

      Deselect:
		TNT1 A 0 A_TakeInventory("Ranger_AxeSelected", 1)
        TNT1 AAAAAAAAAAAAAAAAAAAA 0 A_Lower
        TNT1 A 1 A_Lower
        loop
	  
	  Ready:
        QMJL A 1 A_WeaponReady
        loop

      // 25 tics
      Fire:
        QMJL C 2 A_TakeInventory("MjolnirCrash")
        QMJL B 4
        QMJL C 2 A_FireBullets(0, 0, 1, 0, "MjolnirCheckPuff", 0, 112)
        QMJL D 2 
        QMJL D 0 A_JumpIfInventory("MjolnirCrash", 1, "FireSlam")
        QMJL D 0 A_CustomPunch(75, 1, 0, "MjolnirPuff")
        QMJL E 12
        QMJL D 3
        goto Ready

      FireSlam:
        QMJL D 0 A_JumpIfInventory("SamsaraCurrentWaterLevel",2,"Discharge")
        QMJL D 0 A_JumpIfInventory("QuakeInvisTimer", 1, 2)
        QMJL D 0 A_AlertMonsters

        QMJL D 0 A_PlaySound("quakeweps/mjolnirhit", 5)
        QMJL D 0 A_CustomPunch(75, 1, 0, "MjolnirPuff")
        QMJL D 0 A_JumpIfInventory("StrongerMjolnir", 1, "FireSlamStrong")
        QMJL D 0 A_FireCustomMissile("MJLightningWeak")
        goto FireSlam2


      FireSlamStrong:
        QMJL D 0 A_JumpIfInventory("SPModeOn", 1, "FireSlamCoop")
        QMJL D 0 A_JumpIfInventory("CoopModeOn", 1, "FireSlamCoop")
        QMJL D 0 A_FireCustomMissile("MJLightning")
        goto FireSlam2

      FireSlamCoop:
        QMJL D 0 A_FireCustomMissile("MJLightningCoop")
        goto FireSlam2

      FireSlam2:
        QMJL E 12
        QMJL D 3
        QMJL A 26   // I had to fudge this :\
        goto Ready
      
      Discharge:
        GMJL A 0 A_JumpIfInventory("QuakeInvisTimer", 1, 2)
        GMJL A 0 A_AlertMonsters
        GMJL A 0 A_PlaySound("quakeweps/lightningdischarge", 6, 1, 0, ATTN_NONE)
        GMJL A 1 A_FireCustomMissile("MjolnirDischarge")
        goto FireSlam2 // you're probably dead now
    }
}

actor MjolnirCheckPuff: BulletPuff
{
    VSpeed 0

    +PUFFONACTORS
    +PUFFGETSOWNER
    +BLOODLESSIMPACT
    +NOTIMEFREEZE

    States
    {
      Spawn:
      Crash:
      XDeath:
        TNT1 A 1
        TNT1 A 35 A_GiveToTarget("MjolnirCrash")
        stop
    }
}

actor MjolnirPuff: BulletPuff
{
    VSpeed 0

    +PUFFONACTORS
    +PUFFGETSOWNER
    +BLOODLESSIMPACT

    SeeSound "quakeweps/mjolnirwhack"
    AttackSound "quakeweps/mjolnirwall"
    ActiveSound "quakeweps/mjolnirmiss"
	DamageType "QuakeExplosive"

    States
    {
      Spawn:
      Crash:
      XDeath:
        TNT1 A 1
        stop
    }
}

actor MjolnirPuffSpectral: MjolnirPuff
{
    DamageType "Spectral"
}

ACTOR MjolnirProjectile : LGBeamProjectile
{
	Speed 32
	+RIPPER
	States
	{
		Spawn:
			TNT1 A 0 NoDelay A_ChangeFlag(PAINLESS,Random(0,128))
			TNT1 A 0 A_ChangeFlag("CLIENTSIDEONLY", true)
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,-MomX,-MomY,-MomZ,0,WARPF_ABSOLUTEOFFSET|WARPF_NOCHECKPOSITION)
			TNT1 A 0 A_ChangeFlag("CLIENTSIDEONLY", false)
			TNT1 A 0 A_SpawnItemEx("LGBeam",0,0,0,(MomX*0.001), (MomY*0.001), (MomZ*0.001), Angle, SXF_ABSOLUTEPOSITION|SXF_ABSOLUTEMOMENTUM|SXF_ABSOLUTEANGLE)
			TNT1 A 0 A_ChangeFlag("CLIENTSIDEONLY", true)
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,MomX,MomY,MomZ,0,WARPF_ABSOLUTEOFFSET|WARPF_NOCHECKPOSITION)	
		Moving:
			TNT1 A 0 A_JumpIfCloser(128,1)
			Stop
			TNT1 A 0 A_ChangeFlag("CLIENTSIDEONLY", false)
			TNT1 A 0 A_SpawnItemEx("LGBeam",0,0,0,(MomX*0.001), (MomY*0.001), (MomZ*0.001), Angle, SXF_ABSOLUTEPOSITION|SXF_ABSOLUTEMOMENTUM|SXF_ABSOLUTEANGLE)
			TNT1 A 0 A_ChangeFlag("CLIENTSIDEONLY", true)
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,MomX/5,MomY/5,MomZ/5,0,WARPF_ABSOLUTEOFFSET,1) stop
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,MomX/5,MomY/5,MomZ/5,0,WARPF_ABSOLUTEOFFSET,1) stop
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,MomX/5,MomY/5,MomZ/5,0,WARPF_ABSOLUTEOFFSET,1) stop
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,MomX/5,MomY/5,MomZ/5,0,WARPF_ABSOLUTEOFFSET,1) stop
			TNT1 A 0 A_Warp(AAPTR_DEFAULT,MomX/5,MomY/5,MomZ/5,0,WARPF_ABSOLUTEOFFSET,"Moving") 
			stop
		Remove:
			TNT1 A 1
			stop		
	}
}

Actor MjolnirProjectileCoop : MjolnirProjectile
{
	+THRUSPECIES
	+MTHRUSPECIES
	Species "Player"
}

ACTOR MjolnirProjectileWeak : MjolnirProjectile { Damage (2) }

actor MJLightning
{
    Radius 4
    Height 4
    Projectile
    Speed 20
    RenderStyle Add
    Alpha 0.5
    Scale 0.35
    States
    {
      Spawn:
      Death:
        DPLE B 0
        DPLS B 1 bright ThrustThingZ(0, 32, 1, 0)
        DPLE B 0 A_Stop
        DPLE B 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 4 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 4 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE D 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 4 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE B 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 4 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 4 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE D 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 0 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 4 bright A_CustomMissile("MjolnirProjectile", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        stop
    }
}

Actor MJLightningWeak : MJLightning
{
	States
    {
      Spawn:
      Death:
        DPLE B 0
        DPLS B 1 bright ThrustThingZ(0, 32, 1, 0)
        DPLE B 0 A_Stop
        DPLE B 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 4 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, 30, CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 4 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, 30, CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE D 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 4 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, 30, CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE B 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 4 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, 30, CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 4 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, 30, CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE D 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 0 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 4 bright A_CustomMissile("MjolnirProjectileWeak", 0,0, 30, CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        stop
    }
}

Actor MJLightningCoop : MJLightning
{
	States
    {
      Spawn:
      Death:
        DPLE B 0
        DPLS B 1 bright ThrustThingZ(0, 32, 1, 0)
        DPLE B 0 A_Stop
        DPLE B 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 4 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 4 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE D 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 4 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE B 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE B 4 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE C 4 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
		DPLE D 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 0 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        DPLE D 4 bright A_CustomMissile("MjolnirProjectileCoop", 0,0, random(-30,30), CMF_AIMDIRECTION|CMF_TRACKOWNER, 0)
        stop
    }
}

actor MjolnirDischarge : LGDischarge
{
    States
    {
      Spawn:
        TNT1 A 0
        TNT1 A 0 A_Explode(18 * 250, 4096, 0) // eeeh, dunno about this
        TNT1 A 1 A_Explode(17 * 250, 4096)
        stop
    }
}
